import express from "express";
import http from "http";
import https from "https";
import fs from 'fs'

const app = express();



let imageQueue = [];  // Queue to store image data
let currentImage = ["61, 7, 84", "59, 4, 83", "61, 7, 84", "62, 7, 84", "62, 7, 84", "61, 7, 84", "62, 7, 84", "61, 6, 84", "61, 7, 84", "61, 7, 84", "61, 6, 84", "65, 11, 87", "76, 24, 96", "60, 6, 83", "62, 7, 84", "61, 7, 84", "61, 7, 84", "62, 7, 84", "62, 7, 84", "61, 7, 84", "62, 7, 84", "62, 7, 84", "61, 7, 84", "61, 7, 84", "62, 7, 84", "62, 7, 85", "78, 28, 95", "62, 7, 84", "69, 6, 98", "90, 33, 114", "69, 6, 99", "68, 5, 99", "68, 5, 99", "69, 5, 99", "68, 5, 98", "71, 9, 100", "71, 8, 100", "68, 5, 98", "68, 4, 98", "74, 11, 103", "89, 29, 116", "67, 3, 97", "69, 5, 99", "68, 4, 98", "66, 2, 98", "69, 5, 99", "68, 5, 99", "69, 5, 99", "65, 0, 96", "66, 2, 97", "69, 5, 99", "68, 5, 99", "68, 5, 99", "69, 6, 99", "91, 34, 114", "69, 6, 98", "84, 3, 123", "101, 24, 133", "85, 3, 122", "82, 1, 121", "84, 1, 122", "83, 3, 122", "83, 0, 121", "102, 29, 131", "99, 25, 130", "83, 0, 121", "83, 3, 122", "85, 2, 122", "81, 0, 120", "84, 3, 122", "83, 1, 121", "92, 16, 127", "104, 30, 132", "81, 0, 120", "85, 2, 122", "81, 0, 120", "115, 46, 144", "105, 31, 137", "81, 0, 120", "85, 2, 122", "83, 2, 122", "85, 2, 122", "81, 0, 120", "83, 2, 122", "99, 1, 129", "97, 0, 128", "98, 0, 129", "112, 18, 138", "119, 27, 143", "96, 0, 128", "100, 1, 130", "98, 0, 129", "98, 0, 129", "100, 1, 130", "99, 1, 129", "99, 0, 130", "96, 0, 130", "94, 0, 130", "93, 0, 130", "99, 1, 132", "107, 11, 134", "98, 0, 129", "99, 1, 130", "95, 0, 126", "167, 101, 179", "145, 70, 163", "94, 0, 126", "100, 1, 130", "99, 1, 129", "99, 1, 130", "99, 1, 130", "99, 1, 129", "114, 0, 135", "114, 0, 135", "115, 0, 136", "115, 3, 136", "119, 5, 139", "112, 0, 134", "115, 0, 136", "114, 0, 135", "114, 0, 135", "115, 0, 137", "108, 0, 135", "113, 0, 138", "133, 35, 133", "156, 70, 132", "156, 70, 132", "133, 35, 133", "112, 0, 138", "108, 0, 135", "115, 0, 137", "114, 0, 135", "112, 0, 134", "114, 0, 135", "113, 0, 134", "115, 0, 136", "119, 14, 137", "130, 36, 144", "113, 0, 135", "114, 0, 135", "123, 1, 141", "121, 1, 140", "121, 1, 140", "123, 1, 141", "119, 0, 139", "123, 1, 142", "120, 0, 139", "121, 0, 140", "120, 0, 142", "120, 1, 140", "160, 68, 134", "214, 165, 117", "244, 198, 106", "255, 217, 102", "255, 217, 102", "244, 197, 106", "214, 165, 117", "160, 69, 134", "119, 1, 141", "120, 0, 142", "121, 1, 140", "120, 0, 139", "123, 1, 142", "119, 1, 139", "123, 1, 141", "121, 2, 140", "120, 0, 140", "123, 0, 141", "140, 1, 153", "137, 0, 152", "139, 1, 153", "139, 1, 153", "139, 1, 153", "138, 0, 152", "146, 19, 157", "149, 28, 160", "142, 6, 149", "215, 148, 117", "255, 215, 104", "255, 210, 98", "255, 200, 98", "255, 196, 98", "255, 196, 98", "255, 200, 98", "255, 209, 98", "255, 213, 102", "214, 147, 117", "143, 9, 149", "137, 0, 154", "139, 1, 153", "139, 1, 153", "139, 1, 153", "139, 1, 153", "139, 1, 153", "145, 17, 156", "140, 1, 153", "148, 1, 159", "158, 28, 166", "150, 1, 159", "148, 0, 159", "150, 0, 158", "145, 0, 156", "151, 3, 160", "147, 0, 162", "219, 132, 120", "255, 207, 96", "255, 196, 98", "254, 193, 99", "255, 194, 99", "255, 193, 99", "255, 193, 99", "255, 194, 99", "254, 192, 99", "255, 195, 98", "255, 207, 96", "219, 133, 120", "145, 0, 161", "149, 0, 159", "148, 0, 159", "150, 0, 159", "146, 0, 158", "158, 22, 163", "216, 162, 194", "155, 20, 163", "155, 0, 158", "181, 22, 158", "154, 0, 159", "151, 0, 158", "155, 10, 162", "169, 51, 176", "148, 0, 160", "190, 71, 137", "255, 195, 99", "255, 194, 99", "255, 192, 99", "255, 192, 99", "255, 193, 99", "255, 193, 99", "255, 193, 99", "255, 193, 99", "255, 193, 99", "255, 192, 99", "255, 194, 99", "255, 195, 99", "191, 72, 137", "148, 0, 160", "153, 1, 158", "152, 0, 158", "152, 0, 158", "152, 2, 159", "162, 26, 164", "164, 0, 154", "213, 11, 144", "182, 24, 117", "185, 34, 126", "175, 0, 155", "174, 30, 170", "211, 129, 206", "168, 11, 160", "228, 123, 120", "245, 155, 111", "242, 150, 113", "242, 150, 113", "242, 150, 113", "242, 150, 113", "242, 150, 113", "242, 150, 113", "242, 150, 113", "242, 150, 113", "242, 150, 113", "241, 150, 113", "245, 155, 111", "228, 125, 121", "166, 5, 158", "166, 0, 160", "166, 7, 162", "176, 35, 172", "162, 0, 161", "176, 0, 153", "215, 46, 121", "137, 40, 96", "56, 29, 78", "200, 93, 104", "208, 13, 145", "180, 0, 162", "179, 0, 162", "198, 38, 147", "235, 119, 119", "234, 116, 120", "233, 115, 120", "234, 115, 120", "234, 115, 120", "234, 115, 120", "234, 115, 120", "233, 115, 120", "234, 115, 120", "233, 115, 120", "234, 115, 120", "234, 115, 120", "234, 116, 120", "235, 119, 119", "198, 39, 148", "179, 0, 162", "190, 0, 158", "207, 10, 156", "204, 0, 150", "233, 40, 126", "86, 44, 80", "0, 2, 63", "62, 35, 87", "248, 121, 121", "249, 74, 121", "194, 4, 149", "189, 0, 155", "210, 56, 139", "237, 111, 120", "235, 106, 122", "234, 106, 122", "235, 106, 122", "235, 106, 122", "234, 106, 122", "235, 106, 122", "235, 106, 122", "235, 106, 122", "234, 106, 122", "235, 106, 122", "235, 106, 122", "234, 106, 122", "237, 111, 120", "208, 55, 142", "200, 4, 150", "211, 56, 119", "152, 42, 112", "203, 60, 115", "253, 103, 122", "135, 67, 95", "0, 5, 63", "15, 25, 78", "136, 81, 110", "205, 104, 107", "83, 51, 101", "180, 57, 122", "235, 58, 133", "231, 80, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "231, 78, 137", "233, 81, 136", "220, 51, 138", "242, 64, 122", "224, 129, 106", "14, 32, 81", "9, 23, 75", "59, 54, 101", "77, 44, 82", "71, 7, 91", "68, 17, 99", "73, 19, 105", "77, 11, 93", "66, 16, 97", "110, 36, 108", "170, 45, 132", "237, 46, 150", "240, 49, 149", "238, 49, 148", "240, 49, 149", "238, 49, 148", "238, 49, 148", "238, 49, 148", "238, 49, 148", "238, 49, 148", "238, 49, 148", "240, 49, 149", "238, 49, 148", "240, 49, 149", "237, 46, 149", "163, 31, 112", "209, 74, 116", "187, 66, 115", "72, 16, 96", "70, 19, 105", "65, 10, 95", "64, 1, 87", "176, 2, 143", "167, 2, 138", "149, 1, 126", "172, 1, 142", "167, 2, 138", "145, 0, 126", "171, 1, 144", "153, 5, 127", "161, 4, 133", "173, 4, 140", "154, 4, 128", "175, 4, 142", "174, 4, 141", "173, 4, 140", "173, 4, 140", "174, 4, 141", "175, 4, 141", "154, 5, 128", "173, 4, 140", "161, 4, 133", "153, 5, 128", "170, 0, 143", "144, 0, 126", "148, 0, 128", "181, 1, 146", "156, 2, 130", "167, 2, 137", "176, 2, 143", "159, 2, 151", "115, 4, 122", "112, 4, 120", "154, 3, 148", "117, 3, 124", "114, 3, 122", "135, 3, 135", "103, 3, 115", "131, 3, 133", "118, 3, 125", "124, 3, 128", "128, 3, 131", "137, 3, 137", "135, 3, 136", "135, 3, 136", "137, 3, 137", "128, 3, 131", "124, 3, 128", "118, 3, 125", "131, 3, 133", "103, 3, 115", "135, 3, 135", "115, 3, 122", "105, 3, 116", "143, 3, 140", "135, 3, 135", "113, 4, 121", "159, 2, 151", "114, 3, 121", "151, 3, 145", "93, 2, 108", "89, 2, 105", "143, 3, 140", "100, 2, 112", "87, 2, 105", "141, 3, 138", "95, 2, 109", "102, 2, 114", "138, 2, 137", "96, 2, 110", "138, 2, 137", "118, 2, 124", "118, 2, 124", "138, 2, 137", "97, 2, 110", "138, 3, 137", "102, 2, 114", "95, 2, 109", "141, 3, 138", "87, 2, 105", "99, 2, 112", "144, 3, 141", "89, 2, 105", "91, 2, 107", "151, 3, 145", "114, 2, 121", "160, 2, 151", "143, 2, 141", "164, 2, 147", "158, 2, 148", "155, 2, 148", "136, 2, 136", "176, 2, 155", "161, 2, 151", "136, 2, 136", "176, 2, 155", "157, 2, 148", "163, 2, 149", "167, 2, 153", "165, 2, 151", "166, 2, 151", "167, 2, 153", "163, 2, 149", "157, 2, 149", "176, 2, 155", "136, 2, 136", "160, 2, 150", "177, 2, 155", "136, 2, 136", "155, 2, 148", "158, 2, 148", "164, 2, 148", "144, 2, 142", "160, 2, 151", "77, 1, 98", "112, 2, 111", "126, 3, 117", "77, 1, 98", "71, 1, 95", "117, 2, 115", "121, 2, 116", "70, 1, 95", "109, 2, 110", "124, 2, 116", "73, 1, 96", "143, 2, 124", "85, 1, 101", "117, 1, 113", "119, 1, 114", "83, 1, 100", "141, 2, 123", "73, 1, 96", "126, 2, 117", "112, 2, 112", "68, 1, 94", "123, 2, 116", "117, 2, 114", "71, 1, 95", "78, 1, 98", "127, 2, 117", "114, 2, 112", "75, 1, 97", "180, 2, 139", "195, 2, 145", "152, 1, 129", "150, 1, 128", "172, 2, 136", "183, 2, 141", "150, 1, 128", "159, 1, 131", "187, 2, 142", "160, 2, 134", "164, 2, 136", "190, 2, 144", "148, 1, 129", "179, 1, 141", "179, 2, 141", "148, 1, 129", "190, 2, 145", "163, 1, 134", "159, 1, 131", "187, 2, 142", "158, 1, 131", "150, 1, 128", "183, 2, 141", "171, 2, 136", "150, 1, 128", "152, 1, 129", "195, 2, 145", "181, 1, 140", "123, 1, 122", "99, 1, 113", "103, 1, 114", "142, 1, 128", "147, 1, 130", "101, 1, 113", "102, 1, 113", "153, 1, 131", "127, 1, 122", "97, 1, 112", "147, 1, 130", "139, 1, 127", "97, 0, 112", "142, 1, 128", "142, 1, 128", "97, 0, 112", "139, 1, 128", "147, 1, 131", "97, 0, 112", "128, 1, 122", "153, 1, 131", "102, 1, 114", "101, 1, 113", "146, 2, 130", "142, 1, 128", "103, 1, 114", "99, 1, 113", "123, 1, 122", "132, 0, 128", "132, 0, 128", "156, 1, 135", "173, 1, 142", "132, 0, 129", "133, 0, 129", "142, 1, 132", "181, 2, 145", "134, 1, 129", "133, 0, 129", "180, 1, 144", "142, 1, 132", "130, 0, 128", "165, 1, 139", "165, 1, 139", "130, 0, 127", "142, 1, 131", "180, 1, 143", "133, 0, 128", "134, 1, 128", "181, 2, 143", "142, 1, 132", "133, 0, 128", "132, 0, 128", "173, 1, 141", "156, 1, 135", "132, 0, 128", "132, 0, 128", "166, 1, 140", "176, 1, 143", "199, 1, 150", "165, 1, 140", "167, 1, 142", "167, 1, 142", "200, 2, 154", "173, 1, 144", "166, 1, 142", "172, 1, 144", "203, 1, 153", "167, 1, 142", "165, 1, 141", "188, 1, 148", "188, 1, 147", "165, 1, 139", "168, 1, 140", "203, 1, 152", "172, 1, 142", "166, 1, 140", "173, 1, 141", "200, 2, 144", "167, 1, 140", "167, 1, 140", "165, 1, 139", "199, 1, 150", "176, 1, 143", "166, 1, 140", "141, 1, 131", "169, 2, 134", "142, 1, 133", "133, 1, 130", "131, 1, 130", "164, 1, 132", "157, 1, 134", "132, 1, 130", "132, 0, 130", "155, 1, 133", "171, 1, 136", "131, 1, 130", "131, 1, 130", "165, 1, 135", "165, 1, 135", "131, 1, 130", "131, 1, 130", "170, 1, 136", "155, 1, 133", "132, 1, 130", "132, 1, 131", "157, 1, 132", "164, 1, 132", "131, 1, 131", "133, 1, 131", "142, 1, 133", "169, 2, 134", "141, 1, 131", "202, 1, 140", "172, 1, 139", "164, 0, 138", "165, 0, 139", "176, 1, 139", "197, 1, 139", "166, 0, 138", "166, 0, 139", "164, 0, 139", "197, 1, 139", "177, 1, 139", "165, 0, 139", "164, 0, 139", "188, 0, 139", "188, 0, 138", "163, 0, 137", "165, 0, 137", "177, 0, 137", "197, 1, 139", "164, 0, 139", "166, 0, 138", "166, 0, 137", "197, 1, 138", "176, 0, 138", "165, 0, 137", "164, 0, 137", "172, 0, 137", "202, 1, 138", "195, 1, 146", "189, 1, 145", "191, 1, 145", "190, 1, 146", "216, 2, 141", "193, 1, 144", "190, 1, 145", "191, 1, 145", "191, 1, 145", "217, 2, 144", "193, 1, 145", "190, 1, 145", "189, 1, 145", "206, 2, 143", "205, 2, 141", "189, 1, 141", "191, 1, 141", "193, 1, 141", "217, 2, 143", "191, 1, 145", "191, 1, 144", "190, 1, 141", "192, 1, 141", "216, 2, 138", "190, 1, 141", "191, 1, 141", "189, 1, 141", "195, 1, 142", "174, 1, 160", "175, 1, 160", "173, 1, 161", "187, 3, 151", "193, 4, 149", "174, 1, 161", "175, 1, 160", "174, 1, 161", "183, 2, 156", "203, 5, 148", "173, 0, 161", "175, 1, 160", "172, 1, 161", "195, 4, 153", "195, 3, 153", "172, 1, 161", "175, 1, 160", "173, 0, 161", "203, 5, 148", "182, 2, 156", "174, 1, 160", "175, 1, 161", "174, 1, 161", "193, 4, 149", "187, 3, 152", "173, 1, 162", "175, 1, 160", "174, 1, 160", "193, 0, 173", "192, 0, 174", "195, 0, 172", "218, 5, 157", "194, 0, 173", "193, 0, 174", "193, 0, 174", "191, 0, 175", "212, 4, 161", "204, 2, 165", "191, 0, 175", "193, 0, 174", "191, 0, 175", "208, 3, 163", "208, 3, 163", "191, 0, 175", "193, 0, 174", "192, 0, 175", "204, 2, 165", "211, 4, 161", "191, 0, 175", "193, 0, 174", "192, 0, 174", "194, 0, 173", "218, 5, 157", "195, 0, 172", "193, 0, 174", "193, 0, 173"]; // Current image available on the GET route

app.use(express.json());

function stringToRGBArray(strArray) {
  return strArray.map(color => color.split(',').map(Number));
}

function rgbToHexString(array) {
  return array.map(([r, g, b]) => 
      ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')
  ).join('');
}

setInterval(() => {
  if (imageQueue.length > 0) {
    currentImage = imageQueue.shift();  // Dequeue the next image
    console.log('Updated current image', currentImage);
  }
}, 5000);


app.get("/array", (req, res) => {
  res.setHeader('Content-Type', 'text/plain');
  let rgbArray = stringToRGBArray(currentImage);  
  const hexString = rgbToHexString(rgbArray);  
  console.log(hexString)
  res.send(hexString);
});

app.post("/savearray", (req, res) => {
  if (!Array.isArray(req.body)) {
    return res.status(400).send("Expected an array");
  }

  imageQueue.push(req.body);

  return res.send("Array updated successfully");
});



//REPLACE THESE WITH YOUR OWN CERTS
const options = {
  key: fs.readFileSync('/etc/letsencrypt/live/backend.removegreenscreen.com/privkey.pem'),
  cert: fs.readFileSync('/etc/letsencrypt/live/backend.removegreenscreen.com/fullchain.pem')
} 
const httpsServer = https.createServer(options, app);


httpsServer.listen(8082, () => {
  console.log('listening on 8082...')
})